{% extends "base.html" %}

{% block title %}Cause List - Naya Judicial System{% endblock %}

{% block head %}
<style>
  
  .controls-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
  }

  .search-wrapper input {
    border: 1px solid var(--color-border);
    background: white;
    border-radius: 100px;
    padding: 10px 16px 10px 40px;
    font-size: 14px;
    width: 280px;
    transition: all 0.2s;
  }

  .search-wrapper input:focus {
    outline: none;
    border-color: var(--color-primary);
    width: 320px;
  }

  .table-container {
    background: white;
    border-radius: 16px;
    box-shadow: var(--shadow-sm);
    overflow-x: auto;
    
    border: 1px solid var(--color-border);
  }

  

  
  @media (max-width: 768px) {

    th.hidden-mobile,
    td.hidden-mobile {
      display: none;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="page-header mb-8">
  <h1 class="text-2xl font-bold">Cause List</h1>
  <p class="text-gray-500">Manage and track all scheduled hearings efficiently.</p>
</div>


<div class="controls-bar">
  <div class="font-semibold text-lg flex items-center gap-2">üìÅ Registered Cases</div>
  <div class="relative search-wrapper">
    <span class="absolute left-4 top-3 text-gray-400">üîç</span>
    <input type="text" id="searchInput" placeholder="Search by case number or type...">
  </div>
</div>


<div class="table-container">
  <table class="w-full whitespace-nowrap"> 
    <thead>
      <tr>
        <th>Case Number</th>
        <th>Type</th>
        <th class="hidden-mobile">Witnesses</th>
        <th class="hidden-mobile">Advocates</th>
        <th>Hearing Date</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="caseTableBody">
      
    </tbody>
  </table>
</div>
<div id="paginationControls"></div>
{% endblock %}

{% block scripts %}
<script>
  let currentPage = 1;
  let currentSearch = "";
  const LIMIT = 20;
  let currentCases = []; 

  async function fetchCases(page = 1, search = "") {
    currentPage = page;
    currentSearch = search;

    
    const tbody = document.getElementById('caseTableBody');
    if (tbody) tbody.innerHTML = '<tr><td colspan="7" class="text-center p-8 text-gray-500">Loading...</td></tr>';

    try {
      console.log(`Fetching cases: page=${page}, search="${search}"`);
      const res = await fetch(`/api/cases?page=${page}&limit=${LIMIT}&search=${encodeURIComponent(search)}`);

      if (!res.ok) {
        console.error("API Response not OK", res.status);
        throw new Error("Failed");
      }

      const data = await res.json();
      console.log("API Data received:", data);

      currentCases = data.cases || []; 
      renderCases(currentCases);
      renderPagination(data);
    } catch (e) {
      console.error("Fetch Error:", e);
      if (document.getElementById('caseTableBody')) {
        document.getElementById('caseTableBody').innerHTML = '<tr><td colspan="7" class="text-center p-8 text-red-500">Error loading cases (See console).</td></tr>';
      }
    }
  }

  function renderCases(cases) {
    const tbody = document.getElementById('caseTableBody');
    tbody.innerHTML = '';

    const role = localStorage.getItem("role") || "";
    const isAdmin = (role.toLowerCase().trim() === 'admin');

    if (!cases || cases.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="text-center p-8 text-gray-500">No cases found.</td></tr>';
      return;
    }
    cases.forEach(c => {
      const row = `
                <tr>
                    <td>
                        <div class="font-bold text-gray-900">${c.caseNumber || 'N/A'}</div>
                        <div class="text-xs text-gray-500 md:hidden">${c.title || 'Unknown Title'}</div>
                    </td>
                    <td>${c.caseType || c.type || 'General'}</td>
                    <td class="hidden-mobile">${c.witnesses || 0}</td>
                    <td class="hidden-mobile">${c.advocates || 0}</td>
                    <td>${c.hearingDate || '<span class="text-gray-400">Unscheduled</span>'}</td>
                    <td><span class="badge ${getStatusClass(c.status)}">${c.status || 'Pending'}</span></td>
                    <td>
                        <div class="flex items-center gap-2">
                            <button class="btn-ai" onclick="summarizeCase('${c.caseNumber}')">
                               <span>‚ú®</span>
                            </button>
                            ${isAdmin ? `
                            <button class="p-1 px-2 text-red-500 hover:bg-red-50 rounded" onclick="deleteCase('${c.caseNumber}')" title="Delete Case">
                                <i class="fas fa-trash-alt"></i>
                            </button>` : ''}
                        </div>
                    </td>
                </tr>
            `;
      tbody.insertAdjacentHTML('beforeend', row);
    });
  }

  function renderPagination(data) {
    const container = document.getElementById('paginationControls');
    if (!container) return; 

    const { page, pages, total } = data;

    container.innerHTML = `
        <div class="flex items-center justify-between mt-4 px-2">
            <span class="text-sm text-gray-500">
                Page <b>${page}</b> of <b>${pages}</b> (${total} total records)
            </span>
            <div class="flex gap-2">
                <button 
                    onclick="fetchCases(${page - 1}, '${currentSearch}')" 
                    class="px-3 py-1 bg-white border border-gray-300 rounded text-sm disabled:opacity-50"
                    ${page <= 1 ? 'disabled' : ''}>
                    Previous
                </button>
                <button 
                    onclick="fetchCases(${page + 1}, '${currentSearch}')" 
                    class="px-3 py-1 bg-white border border-gray-300 rounded text-sm disabled:opacity-50"
                    ${page >= pages ? 'disabled' : ''}>
                    Next
                </button>
            </div>
        </div>
      `;
  }

  function getStatusClass(status) {
    if (!status) return 'pending';
    const s = status.toLowerCase();
    if (s === 'scheduled') return 'scheduled';
    if (s === 'closed' || s === 'completed') return 'completed';
    return 'pending';
  }

  
  window.deleteCase = async function (caseNo) {
    if (!confirm(`Are you sure you want to permanently delete case ${caseNo}?`)) return;

    try {
      const res = await fetch(`/api/cases/${caseNo}`, { method: 'DELETE' });
      const data = await res.json();
      if (res.ok) {
        fetchCases(currentPage, currentSearch); 
      } else {
        alert(data.error || "Delete failed");
      }
    } catch (e) {
      alert("Error deleting case");
    }
  }

  
  let debounceTimer;
  document.getElementById('searchInput').addEventListener('input', (e) => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      fetchCases(1, e.target.value);
    }, 400);
  });

  
  window.summarizeCase = async function (caseNo) {
    const caseData = currentCases.find(c => c.caseNumber === caseNo);
    if (!caseData) return;

    const modal = document.getElementById('summaryModal');
    const content = document.getElementById('modalContent');
    modal.classList.add('visible');

    content.innerHTML = '<div class="text-center p-8"><div class="text-3xl mb-4 animate-bounce">ü§ñ</div>Analyzing...</div>';

    const text = caseData.description || `Case: ${caseData.caseNumber}. Type: ${caseData.caseType}. Status: ${caseData.status}.`;

    try {
      const res = await fetch('/api/ai/summarize', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ case_text: text })
      });
      const data = await res.json();
      content.innerHTML = `
                <div class="bg-slate-50 p-4 rounded-lg mb-4 border text-sm italic text-gray-600">
                    Input: ${text.substring(0, 100)}...
                </div>
                <h3 class="font-bold mb-2">AI Analysis</h3>
                <p class="whitespace-pre-wrap">${data.summary || "No summary."}</p>
            `;
    } catch (e) {
      content.innerHTML = '<div class="text-center text-red-500">Error connecting to AI.</div>';
    }
  }

  window.closeModal = function () {
    document.getElementById('summaryModal').classList.remove('visible');
  }

  fetchCases();
</script>
{% endblock %}