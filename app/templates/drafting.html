{% extends "base.html" %}

{% block title %}Drafting Assistant - Naya Judicial System{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto h-[calc(100vh-140px)] flex flex-col">
    
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Judgment Drafting Assistant</h1>
            <p class="text-sm text-gray-500">AI-powered legal drafting for orders and final judgments.</p>
        </div>
        <div class="flex gap-2">
            <button onclick="clearAll()"
                class="px-4 py-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 text-sm font-medium">Clear</button>
            <button onclick="saveDraft()"
                class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm font-medium flex items-center gap-2">
                <span class="iconify" data-icon="lucide:save"></span> Save Draft
            </button>
        </div>
    </div>

    
    <div class="flex-1 grid grid-cols-2 gap-6 min-h-0">

        
        <div class="flex flex-col gap-4">
            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm h-full flex flex-col">
                <label class="block text-sm font-medium text-gray-700 mb-2">Case Facts / Arguments</label>
                <div class="mb-2">
                    <select id="templateSelect" onchange="loadTemplate()"
                        class="w-full text-sm border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        <option value="">-- Select Template / Quick Load --</option>
                        <option value="bail">Bail Application Order</option>
                        <option value="cheque">Section 138 NI Act Judgment</option>
                        <option value="recovery">Civil Suit Recovery</option>
                    </select>
                </div>
                <textarea id="caseFacts"
                    class="flex-1 w-full p-4 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none resize-none font-mono"
                    placeholder="Enter case briefs, admitted facts, and petitioner arguments here..."></textarea>

                <div class="mt-4 flex justify-end">
                    <button onclick="generateDraft()"
                        class="px-6 py-2.5 bg-gradient-to-r from-violet-600 to-indigo-600 text-white font-medium rounded-lg hover:shadow-lg transition flex items-center gap-2">
                        <span class="iconify" data-icon="lucide:sparkles"></span> Generate Draft
                    </button>
                </div>
            </div>
        </div>

        
        <div class="flex flex-col gap-4">
            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm h-full flex flex-col relative">
                <label class="block text-sm font-medium text-gray-700 mb-2">Generated Judgment</label>

                
                <div id="loadingOverlay"
                    class="hidden absolute inset-0 bg-white/80 z-10 flex items-center justify-center rounded-xl">
                    <div class="text-center">
                        <span class="iconify animate-spin text-indigo-600 text-4xl mx-auto mb-2"
                            data-icon="lucide:loader"></span>
                        <p class="text-sm text-gray-500">Drafting judgment based on precedents...</p>
                    </div>
                </div>

                <div id="outputArea"
                    class="flex-1 w-full p-8 bg-white border border-gray-200 rounded-lg text-sm text-gray-800 leading-relaxed overflow-y-auto font-serif shadow-inner"
                    contenteditable="true">

                    <p class="text-gray-400 italic text-center mt-20">The AI generated draft will appear here. You can
                        edit it directly.</p>
                </div>

                <div class="mt-2 flex justify-between text-xs text-gray-400">
                    <span>*Always review AI generated content before signing.</span>
                    <span id="wordCount">0 words</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const templates = {
        bail: "Petitioner Name: \nRespondent: State of ...\nCrime No: \nOffenses: IPC 420, 406\n\nArguments:\n1. Accused in custody since 60 days.\n2. Investigation complete, charge sheet filed.\n3. No flight risk.",
        cheque: "Complainant: \nAccused: \nCheque Amount: Rs. 5,00,000\nReturn Reason: Insufficient Funds\n\nDefense: Signature denied, cheque lost.",
        recovery: "Plaintiff: \nDefendant: \nSuit for recovery of Rs. 10,00,000 based on promissory note.\n\nIssue 1. Whether the suit is barred by limitation?\nIssue 2. Whether the plaintiff proves the execution of the note?"
    };

    function loadTemplate() {
        const val = document.getElementById('templateSelect').value;
        if (val && templates[val]) {
            document.getElementById('caseFacts').value = templates[val];
        }
    }

    async function generateDraft() {
        const facts = document.getElementById('caseFacts').value;
        if (!facts.trim()) {
            alert("Please enter case facts first.");
            return;
        }

        const overlay = document.getElementById('loadingOverlay');
        const output = document.getElementById('outputArea');

        overlay.classList.remove('hidden');

        try {
            const res = await fetch('/api/draft', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ facts })
            });
            const data = await res.json();

            
            output.innerHTML = data.draft.replace(/\n/g, '<br>');
            updateWordCount();
        } catch (e) {
            console.error(e);
            alert("Error generating draft.");
        } finally {
            overlay.classList.add('hidden');
        }
    }

    function clearAll() {
        if (confirm("Clear all text?")) {
            document.getElementById('caseFacts').value = '';
            document.getElementById('outputArea').innerHTML = '';
            document.getElementById('templateSelect').value = '';
        }
    }

    function saveDraft() {
        alert("Draft saved to Case Vault successfully!");
    }

    function updateWordCount() {
        const text = document.getElementById('outputArea').innerText;
        document.getElementById('wordCount').innerText = text.split(/\s+/).filter(w => w.length > 0).length + " words";
    }

    document.getElementById('outputArea').addEventListener('input', updateWordCount);
</script>
{% endblock %}