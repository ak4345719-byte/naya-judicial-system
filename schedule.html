{% extends "base.html" %}

{% block title %}Schedule - Naya Judicial System{% endblock %}

{% block head %}
<style>
    .ai-btn {
        background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        display: flex;
        align-items: center;
        gap: 8px;
        transition: transform 0.2s;
    }

    .ai-btn:hover {
        transform: translateY(-2px);
    }

    .timeline {
        position: relative;
        padding-left: 40px;
        margin-top: 20px;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 19px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--color-border);
    }

    .event-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        border: 1px solid #f3f4f6;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
        position: relative;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .event-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
    }

    .event-card::before {
        content: '';
        position: absolute;
        left: -33px;
        top: 28px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: white;
        border: 4px solid var(--color-primary);
        z-index: 10;
    }

    .risk-badge {
        padding: 4px 10px;
        border-radius: 100px;
        font-size: 12px;
        font-weight: 700;
        color: white;
    }

    .risk-Low {
        background: #10b981;
    }

    .risk-Medium {
        background: #f59e0b;
    }

    .risk-High {
        background: #ef4444;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-8">
    <div>
        <h1 class="text-2xl font-bold">Daily Court Schedule</h1>
        <p class="text-gray-500 mt-1">AI-Optimized Hearing Timeline</p>
    </div>
    <button class="ai-btn" onclick="rescheduleAI()">
        <span>✨</span> Reschedule Using AI
    </button>
</div>

<div id="scheduleTimeline" class="timeline">
    <div class="p-8 text-gray-500">Loading schedule...</div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadSchedule() {
        const loadingHtml = '<div class="p-8 flex items-center gap-3 text-indigo-600"><i class="fas fa-spinner fa-spin"></i> Loading AI Schedule...</div>';
        const container = document.getElementById('scheduleTimeline');

        
        if (!container.children.length) container.innerHTML = loadingHtml;

        try {
            const res = await fetch('/api/daily-schedule');
            const events = await res.json();

            container.innerHTML = '';
            if (events.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 px-6 bg-white rounded-2xl border border-dashed border-gray-300">
                        <div class="w-16 h-16 bg-indigo-50 text-indigo-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800">No Hearings Scheduled</h3>
                        <p class="text-gray-500 text-sm mt-1">Use "Reschedule Using AI" to automatically assign pending cases.</p>
                    </div>`;
                return;
            }

            events.sort((a, b) => a.start_time.localeCompare(b.start_time));

            events.forEach(ev => {
                const isRisk = ev.risk_level === 'High' || ev.risk_level === 'Medium';

                container.innerHTML += `
                 <div class="event-card group border-l-4 ${ev.risk_level === 'High' ? 'border-red-500' : 'border-indigo-500'}">
                   <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
                      <div class="flex items-center gap-3">
                          <span class="bg-gray-100 text-gray-700 px-3 py-1 rounded-md text-sm font-bold font-mono tracking-tight">
                              ${ev.start_time}
                          </span>
                          <span class="text-gray-300 font-light hidden md:inline">|</span>
                          <span class="text-indigo-600 font-semibold text-sm flex items-center gap-1">
                              <i class="far fa-clock"></i> ${ev.duration_minutes} min
                          </span>
                      </div>
                      <span class="risk-badge risk-${ev.risk_level} shadow-sm px-3 py-1 order-first md:order-last w-fit flex items-center gap-1.5">
                          ${ev.risk_level === 'High' ? '<i class="fas fa-exclamation-circle"></i>' : ''}
                          ${ev.risk_level} Risk
                      </span>
                   </div>
                   
                   <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
                     <div>
                        <div class="flex items-center gap-2 mb-1">
                             <h3 class="text-xl font-bold text-gray-900 group-hover:text-indigo-700 transition-colors">Case #${ev.case_number}</h3>
                             <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider bg-gray-100 text-gray-500 border border-gray-200">
                                 ${ev.case_type}
                             </span>
                        </div>
                        <p class="text-sm text-gray-500 mb-2">Scheduled hearing regarding the defined charges and evidence review.</p>
                        
                        
                        <div class="flex items-center gap-3 text-xs text-gray-500 bg-gray-50 w-fit px-3 py-1.5 rounded-lg border border-gray-100">
                            <span class="flex items-center gap-1"><i class="fas fa-building text-gray-400"></i> ${ev.court_name || 'TBD'}</span>
                            <span class="w-px h-3 bg-gray-300"></span>
                            <span class="flex items-center gap-1"><i class="fas fa-door-open text-gray-400"></i> ${ev.court_room || 'TBD'}</span>
                        </div>
                     </div>
                     
                     <div class="flex items-center gap-3 w-full md:w-auto">
                        <div class="flex-1 md:flex-none p-3 bg-indigo-50/50 rounded-xl border border-indigo-100 flex items-center gap-3">
                           <div class="w-8 h-8 rounded-full bg-white text-indigo-600 shadow-sm flex items-center justify-center text-xs font-bold border border-indigo-50">JU</div>
                           <div class="flex flex-col">
                               <span class="text-[10px] text-indigo-400 font-bold uppercase tracking-wide">Presiding Judge</span>
                               <span class="text-sm font-bold text-gray-800">${ev.judge_name}</span>
                           </div>
                        </div>
                     </div>
                   </div>
                 </div>
               `;
            });
        } catch (e) {
            console.error(e);
            container.innerHTML = '<div class="text-red-500 p-4 bg-red-50 rounded-lg">Failed to load schedule. Check console.</div>';
        }
    }

    async function rescheduleAI() {
        const btn = document.querySelector('.ai-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span>⏳</span> Optimizing...';
        btn.disabled = true;
        try {
            const res = await fetch('/api/reschedule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date: new Date().toISOString().split('T')[0] })
            });
            if (res.ok) loadSchedule();
            else alert("Failed");
        } catch (e) { alert("Error"); }
        finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
    loadSchedule();
</script>
{% endblock %}